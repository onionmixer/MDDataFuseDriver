# WS14 mdfsck Frame Builder Audit

Date: 2026-02-17

Scope: `w31/extract/mdfsck.exe` command-frame builder functions.

## func `0x3994`
- frame length setup:
  - `0x39b0: push 0x4a`
  - `0x39fb: push 0x4a`
  - `0x3a69: push 0x20`
- frame type byte setup:
  - `0x39ac: mov byte ptr [bp - 0x49], 2`
  - `0x3a61: mov byte ptr [bp - 0x20], 2`
- frame subtype byte setup:
  - `0x3a65: mov byte ptr [bp - 0x1f], 4`
- transport calls:
  - TX `0x39ba: lcall 0x3f7, 0x1396`
  - TX `0x3a71: lcall 0x3f7, 0x1396`
  - RX `0x3a05: lcall 0x3f7, 0x1298`
- error/report string-id pushes:
  - `0x39c8: push 0x13f6`
  - `0x3a7f: push 0x1401`

```asm
0x3994: enter 0x4a, 0
0x3998: push di
0x3999: push si
0x399a: xor ax, ax
0x399c: mov cx, 0x25
0x399f: lea di, [bp - 0x4a]
0x39a2: push ss
0x39a3: pop es
0x39a4: rep stosw word ptr es:[di], ax
0x39a6: mov al, byte ptr [bp + 0xc]
0x39a9: mov byte ptr [bp - 0x4a], al
0x39ac: mov byte ptr [bp - 0x49], 2
0x39b0: push 0x4a
0x39b2: lea ax, [bp - 0x4a]
0x39b5: push ss
0x39b6: push ax
0x39b7: push word ptr [bp + 6]
0x39ba: lcall 0x3f7, 0x1396
0x39bf: add sp, 8
0x39c2: cmp ax, 0x4a
0x39c5: je 0x39da
0x39c7: push ds
0x39c8: push 0x13f6
0x39cb: lcall 0x3f7, 0x1736
0x39d0: add sp, 4
0x39d3: mov ax, 0xffff
0x39d6: pop si
0x39d7: pop di
0x39d8: leave
0x39d9: retf
0x39da: cmp byte ptr [bp - 0x47], 0
0x39de: je 0x39ea
0x39e0: mov al, byte ptr [bp - 0x47]
0x39e3: sub ah, ah
0x39e5: mov word ptr [0x13d8], ax
0x39e8: jmp 0x39d3
0x39ea: push ds
0x39eb: lea si, [bp - 0x3a]
0x39ee: mov ax, ss
0x39f0: mov ds, ax
0x39f2: les di, ptr [bp + 8]
0x39f5: mov cx, 0x1d
0x39f8: rep movsw word ptr es:[di], word ptr [si]
0x39fa: pop ds
0x39fb: push 0x4a
0x39fd: lea ax, [bp - 0x4a]
0x3a00: push ss
0x3a01: push ax
0x3a02: push word ptr [bp + 6]
0x3a05: lcall 0x3f7, 0x1298
0x3a0a: add sp, 8
0x3a0d: cmp ax, 0x4a
0x3a10: je 0x3a18
0x3a12: push ds
0x3a13: push 0x13fc
0x3a16: jmp 0x39cb
0x3a18: cmp byte ptr [bp - 0x47], 0
0x3a1c: jne 0x39e0
0x3a1e: xor ax, ax
0x3a20: pop si
0x3a21: pop di
0x3a22: leave
0x3a23: retf
0x3a24: push bp
0x3a25: mov bp, sp
0x3a27: push 2
0x3a29: push word ptr [bp + 0xa]
0x3a2c: push word ptr [bp + 8]
0x3a2f: push word ptr [bp + 6]
0x3a32: push cs
0x3a33: call 0x3994
0x3a36: leave
0x3a37: retf
0x3a38: push bp
0x3a39: mov bp, sp
0x3a3b: push 1
0x3a3d: push word ptr [bp + 0xa]
0x3a40: push word ptr [bp + 8]
0x3a43: push word ptr [bp + 6]
0x3a46: push cs
```

## func `0x3a4c`
- frame length setup:
  - `0x3a69: push 0x20`
  - `0x3aa2: push 0x20`
  - `0x3b0a: push 0x20`
  - `0x3b44: push 0x20`
- frame type byte setup:
  - `0x3a61: mov byte ptr [bp - 0x20], 2`
  - `0x3aee: mov byte ptr [bp - 0x20], 2`
- frame subtype byte setup:
  - `0x3a65: mov byte ptr [bp - 0x1f], 4`
  - `0x3af2: mov byte ptr [bp - 0x1f], 5`
- transport calls:
  - TX `0x3a71: lcall 0x3f7, 0x1396`
  - TX `0x3b14: lcall 0x3f7, 0x1396`
  - RX `0x3aaa: lcall 0x3f7, 0x1298`
  - RX `0x3b4e: lcall 0x3f7, 0x1298`
- error/report string-id pushes:
  - `0x3a7f: push 0x1401`
  - `0x3ab8: push 0x1407`

```asm
0x3a4c: enter 0x20, 0
0x3a50: push di
0x3a51: push si
0x3a52: mov si, word ptr [bp + 6]
0x3a55: xor ax, ax
0x3a57: mov cx, 0x10
0x3a5a: lea di, [bp - 0x20]
0x3a5d: push ss
0x3a5e: pop es
0x3a5f: rep stosw word ptr es:[di], ax
0x3a61: mov byte ptr [bp - 0x20], 2
0x3a65: mov byte ptr [bp - 0x1f], 4
0x3a69: push 0x20
0x3a6b: lea ax, [bp - 0x20]
0x3a6e: push ss
0x3a6f: push ax
0x3a70: push si
0x3a71: lcall 0x3f7, 0x1396
0x3a76: add sp, 8
0x3a79: cmp ax, 0x20
0x3a7c: je 0x3a92
0x3a7e: push ds
0x3a7f: push 0x1401
0x3a82: lcall 0x3f7, 0x1736
0x3a87: add sp, 4
0x3a8a: mov ax, 0xffff
0x3a8d: pop si
0x3a8e: pop di
0x3a8f: leave
0x3a90: retf
0x3a91: nop
0x3a92: cmp byte ptr [bp - 0x1d], 0
0x3a96: je 0x3aa2
0x3a98: mov al, byte ptr [bp - 0x1d]
0x3a9b: sub ah, ah
0x3a9d: mov word ptr [0x13d8], ax
0x3aa0: jmp 0x3a8a
0x3aa2: push 0x20
0x3aa4: lea ax, [bp - 0x20]
0x3aa7: push ss
0x3aa8: push ax
0x3aa9: push si
0x3aaa: lcall 0x3f7, 0x1298
0x3aaf: add sp, 8
0x3ab2: cmp ax, 0x20
0x3ab5: je 0x3abe
0x3ab7: push ds
0x3ab8: push 0x1407
0x3abb: jmp 0x3a82
0x3abd: nop
0x3abe: cmp byte ptr [bp - 0x1d], 0
0x3ac2: jne 0x3a98
0x3ac4: push ds
0x3ac5: lea si, [bp - 0x10]
0x3ac8: mov ax, ss
0x3aca: mov ds, ax
0x3acc: les di, ptr [bp + 8]
0x3acf: mov cx, 8
0x3ad2: rep movsw word ptr es:[di], word ptr [si]
0x3ad4: pop ds
0x3ad5: xor ax, ax
0x3ad7: pop si
0x3ad8: pop di
0x3ad9: leave
0x3ada: retf
0x3adb: nop
0x3adc: enter 0x20, 0
0x3ae0: push di
0x3ae1: push si
0x3ae2: xor ax, ax
0x3ae4: mov cx, 0x10
0x3ae7: lea di, [bp - 0x20]
0x3aea: push ss
0x3aeb: pop es
0x3aec: rep stosw word ptr es:[di], ax
0x3aee: mov byte ptr [bp - 0x20], 2
0x3af2: mov byte ptr [bp - 0x1f], 5
0x3af6: mov ax, word ptr [bp + 8]
0x3af9: mov dx, word ptr [bp + 0xa]
0x3afc: push ds
```

## func `0x3adc`
- frame length setup:
  - `0x3b0a: push 0x20`
  - `0x3b44: push 0x20`
  - `0x3ba0: push 0x208`
  - `0x3bdc: push 0x208`
- frame type byte setup:
  - `0x3aee: mov byte ptr [bp - 0x20], 2`
  - `0x3b96: mov byte ptr [bp - 0x208], 2`
- frame subtype byte setup:
  - `0x3af2: mov byte ptr [bp - 0x1f], 5`
  - `0x3b9b: mov byte ptr [bp - 0x207], 6`
- transport calls:
  - TX `0x3b14: lcall 0x3f7, 0x1396`
  - TX `0x3baa: lcall 0x3f7, 0x1396`
  - RX `0x3b4e: lcall 0x3f7, 0x1298`
  - RX `0x3be6: lcall 0x3f7, 0x1298`
- error/report string-id pushes:
  - `0x3b5c: push 0x1412`
  - `0x3bb8: push 0x1417`

```asm
0x3adc: enter 0x20, 0
0x3ae0: push di
0x3ae1: push si
0x3ae2: xor ax, ax
0x3ae4: mov cx, 0x10
0x3ae7: lea di, [bp - 0x20]
0x3aea: push ss
0x3aeb: pop es
0x3aec: rep stosw word ptr es:[di], ax
0x3aee: mov byte ptr [bp - 0x20], 2
0x3af2: mov byte ptr [bp - 0x1f], 5
0x3af6: mov ax, word ptr [bp + 8]
0x3af9: mov dx, word ptr [bp + 0xa]
0x3afc: push ds
0x3afd: lea di, [bp - 0x10]
0x3b00: mov si, ax
0x3b02: mov ds, dx
0x3b04: mov cx, 8
0x3b07: rep movsw word ptr es:[di], word ptr [si]
0x3b09: pop ds
0x3b0a: push 0x20
0x3b0c: lea ax, [bp - 0x20]
0x3b0f: push ss
0x3b10: push ax
0x3b11: push word ptr [bp + 6]
0x3b14: lcall 0x3f7, 0x1396
0x3b19: add sp, 8
0x3b1c: cmp ax, 0x20
0x3b1f: je 0x3b34
0x3b21: push ds
0x3b22: push 0x140c
0x3b25: lcall 0x3f7, 0x1736
0x3b2a: add sp, 4
0x3b2d: mov ax, 0xffff
0x3b30: pop si
0x3b31: pop di
0x3b32: leave
0x3b33: retf
0x3b34: cmp byte ptr [bp - 0x1d], 0
0x3b38: je 0x3b44
0x3b3a: mov al, byte ptr [bp - 0x1d]
0x3b3d: sub ah, ah
0x3b3f: mov word ptr [0x13d8], ax
0x3b42: jmp 0x3b2d
0x3b44: push 0x20
0x3b46: lea ax, [bp - 0x20]
0x3b49: push ss
0x3b4a: push ax
0x3b4b: push word ptr [bp + 6]
0x3b4e: lcall 0x3f7, 0x1298
0x3b53: add sp, 8
0x3b56: cmp ax, 0x20
0x3b59: je 0x3b62
0x3b5b: push ds
0x3b5c: push 0x1412
0x3b5f: jmp 0x3b25
0x3b61: nop
0x3b62: cmp byte ptr [bp - 0x1d], 0
0x3b66: jne 0x3b3a
0x3b68: push ds
0x3b69: lea si, [bp - 0x10]
0x3b6c: mov ax, ss
0x3b6e: mov ds, ax
0x3b70: les di, ptr [bp + 8]
0x3b73: mov cx, 8
0x3b76: rep movsw word ptr es:[di], word ptr [si]
0x3b78: pop ds
0x3b79: xor ax, ax
0x3b7b: pop si
0x3b7c: pop di
0x3b7d: leave
0x3b7e: retf
0x3b7f: nop
0x3b80: enter 0x208, 0
0x3b84: push di
0x3b85: push si
0x3b86: mov si, word ptr [bp + 6]
0x3b89: xor ax, ax
0x3b8b: mov cx, 0x104
0x3b8e: lea di, [bp - 0x208]
```

## func `0x3b80`
- frame length setup:
  - `0x3ba0: push 0x208`
  - `0x3bdc: push 0x208`
  - `0x3c4c: push 0x208`
  - `0x3c8a: push 0x208`
- frame type byte setup:
  - `0x3b96: mov byte ptr [bp - 0x208], 2`
  - `0x3c2d: mov byte ptr [bp - 0x208], 2`
- frame subtype byte setup:
  - `0x3b9b: mov byte ptr [bp - 0x207], 6`
- transport calls:
  - TX `0x3baa: lcall 0x3f7, 0x1396`
  - TX `0x3c58: lcall 0x3f7, 0x1396`
  - RX `0x3be6: lcall 0x3f7, 0x1298`
  - RX `0x3c96: lcall 0x3f7, 0x1298`
- error/report string-id pushes:
  - `0x3bb8: push 0x1417`

```asm
0x3b80: enter 0x208, 0
0x3b84: push di
0x3b85: push si
0x3b86: mov si, word ptr [bp + 6]
0x3b89: xor ax, ax
0x3b8b: mov cx, 0x104
0x3b8e: lea di, [bp - 0x208]
0x3b92: push ss
0x3b93: pop es
0x3b94: rep stosw word ptr es:[di], ax
0x3b96: mov byte ptr [bp - 0x208], 2
0x3b9b: mov byte ptr [bp - 0x207], 6
0x3ba0: push 0x208
0x3ba3: lea ax, [bp - 0x208]
0x3ba7: push ss
0x3ba8: push ax
0x3ba9: push si
0x3baa: lcall 0x3f7, 0x1396
0x3baf: add sp, 8
0x3bb2: cmp ax, 0x208
0x3bb5: je 0x3bca
0x3bb7: push ds
0x3bb8: push 0x1417
0x3bbb: lcall 0x3f7, 0x1736
0x3bc0: add sp, 4
0x3bc3: mov ax, 0xffff
0x3bc6: pop si
0x3bc7: pop di
0x3bc8: leave
0x3bc9: retf
0x3bca: cmp byte ptr [bp - 0x205], 0
0x3bcf: je 0x3bdc
0x3bd1: mov al, byte ptr [bp - 0x205]
0x3bd5: sub ah, ah
0x3bd7: mov word ptr [0x13d8], ax
0x3bda: jmp 0x3bc3
0x3bdc: push 0x208
0x3bdf: lea ax, [bp - 0x208]
0x3be3: push ss
0x3be4: push ax
0x3be5: push si
0x3be6: lcall 0x3f7, 0x1298
0x3beb: add sp, 8
0x3bee: cmp ax, 0x208
0x3bf1: je 0x3bfa
0x3bf3: push ds
0x3bf4: push 0x141d
0x3bf7: jmp 0x3bbb
0x3bf9: nop
0x3bfa: cmp byte ptr [bp - 0x205], 0
0x3bff: jne 0x3bd1
0x3c01: push ds
0x3c02: lea si, [bp - 0x1f8]
0x3c06: mov ax, ss
0x3c08: mov ds, ax
0x3c0a: les di, ptr [bp + 8]
0x3c0d: mov cx, 0xfc
0x3c10: rep movsw word ptr es:[di], word ptr [si]
0x3c12: pop ds
0x3c13: xor ax, ax
0x3c15: pop si
0x3c16: pop di
0x3c17: leave
0x3c18: retf
0x3c19: nop
0x3c1a: enter 0x208, 0
0x3c1e: push di
0x3c1f: push si
0x3c20: xor ax, ax
0x3c22: mov cx, 0x104
0x3c25: lea di, [bp - 0x208]
0x3c29: push ss
0x3c2a: pop es
0x3c2b: rep stosw word ptr es:[di], ax
0x3c2d: mov byte ptr [bp - 0x208], 2
0x3c32: mov byte ptr [bp - 0x207], 7
0x3c37: mov ax, word ptr [bp + 8]
0x3c3a: mov dx, word ptr [bp + 0xa]
0x3c3d: push ds
0x3c3e: lea di, [bp - 0x1f8]
```

## Conservative Findings
- `mdfsck` uses structured request buffers with explicit fixed lengths (`0x20`, `0x208`, `0x4a`).
- Multiple builders initialize leading bytes to `type=2` and subtype values (`4`, `5`, `6`) before transport calls.
- Calls to imported transport entry points (`0x3f7:0x1396` then `0x3f7:0x1298`) are consistent with request/response framing.
- This constrains command payload structure shape but does not yet map these frame subtypes to MDCTL opcode IDs.
